<!DOCTYPE html>
<html lang="th">
<head>
    <title>นักรบโภชนาการ VR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif; /* ใช้ฟอนต์ที่อ่านง่าย */
            background-color: #111;
            color: #fff;
            overflow: hidden; /* ป้องกันการเลื่อนหน้าจอ */
            cursor: crosshair; /* เปลี่ยนเคอร์เซอร์เป็นเป้าเล็ง */
        }
        canvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
            pointer-events: none; /* ทำให้ UI ไม่บังการคลิกใน VR */
        }
        .score {
            font-size: 5vw; /* ขนาดตัวอักษรปรับตามความกว้างจอ */
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        }
        .message {
            font-size: 3vw;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 15px;
            line-height: 1.5;
        }
        #VRButton {
            position: absolute !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 100;
        }
    </style>
    <!-- โหลด Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="ui">
        <div id="score" class="score">คะแนน: 0 | เวลา: 30</div>
        <div id="message" class="message">คลิก หรือ กดปุ่ม Trigger<br>เพื่อเริ่มเกม!</div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/webxr/VRButton.js';

        // --- การตั้งค่าพื้นฐาน ---
        let camera, scene, renderer;
        let controller1, controller2;
        let saber1, saber2;

        // --- ตัวแปรสำหรับเมาส์และคีย์บอร์ด ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- ตัวแปรสำหรับเกม ---
        const foods = [];
        let score = 0;
        let isPlaying = false;
        let spawnInterval;
        let gameTimer;
        let remainingTime = 0;
        const GAME_DURATION = 30;

        init();
        animate();
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x201547);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 2); // ขยับกล้องถอยหลังเล็กน้อยสำหรับโหมดเดสก์ท็อป

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            document.body.appendChild(VRButton.createButton(renderer));

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            const floorGeometry = new THREE.PlaneGeometry(10, 10, 10, 10);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, wireframe: true });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            
            // --- ตั้งค่าคอนโทรลเลอร์ VR ---
            function onControllerConnected(controller) {
                controller.addEventListener('selectstart', startGame);
            }
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('connected', () => onControllerConnected(controller1));
            scene.add(controller1);

            controller2 = renderer.xr.getController(1);
            controller2.addEventListener('connected', () => onControllerConnected(controller2));
            scene.add(controller2);

            const saberGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8, 32);
            
            const saberMaterial1 = new THREE.MeshStandardMaterial({ color: 0x22aaff, emissive: 0x22aaff, emissiveIntensity: 1 });
            saber1 = new THREE.Mesh(saberGeometry, saberMaterial1);
            saber1.rotation.x = -Math.PI / 2;
            controller1.add(saber1);

            const saberMaterial2 = new THREE.MeshStandardMaterial({ color: 0xff2255, emissive: 0xff2255, emissiveIntensity: 1 });
            saber2 = new THREE.Mesh(saberGeometry, saberMaterial2);
            saber2.rotation.x = -Math.PI / 2;
            controller2.add(saber2);

            // --- ตั้งค่าการควบคุมด้วยเมาส์ ---
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('mousedown', onMouseDown, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseDown(event) {
            if (!isPlaying) {
                startGame();
            } else {
                // ทำให้คลิกเมาส์เหมือนการ "ฟัน"
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
                handleMouseCollision();
            }
        }

        // --- กลไกของเกม ---
        function startGame() {
            if (isPlaying) return;

            if (spawnInterval) clearInterval(spawnInterval);
            if (gameTimer) clearTimeout(gameTimer);

            foods.forEach(food => scene.remove(food));
            foods.length = 0;

            isPlaying = true;
            score = 0;
            remainingTime = GAME_DURATION;
            updateScoreUI();
            document.getElementById('message').style.display = 'none';

            spawnInterval = setInterval(spawnFood, 1000);
            gameTimer = setTimeout(endGame, GAME_DURATION * 1000);
        }

        function endGame() {
            isPlaying = false;
            clearInterval(spawnInterval);
            clearTimeout(gameTimer);
            
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `เกมจบแล้ว! คะแนนสุดท้าย: ${score}<br>คลิก หรือ กด Trigger เพื่อเล่นอีกครั้ง`;
            messageEl.style.display = 'block';
        }

        function spawnFood() {
            if (!isPlaying) return;
            const isGoodFood = Math.random() > 0.3;
            let food;

            if (isGoodFood) {
                const geometry = new THREE.SphereGeometry(0.15, 16, 16);
                const colors = [0x00ff00, 0xffff00, 0xffa500];
                const color = colors[Math.floor(Math.random() * colors.length)];
                const material = new THREE.MeshStandardMaterial({ color: color });
                food = new THREE.Mesh(geometry, material);
                food.userData = { type: 'good', points: 10 };
            } else {
                const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const material = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
                food = new THREE.Mesh(geometry, material);
                food.userData = { type: 'bad', points: -5 };
            }

            food.position.x = (Math.random() - 0.5) * 4;
            food.position.y = 1 + Math.random() * 1;
            food.position.z = -10;

            scene.add(food);
            foods.push(food);
        }
        
        function updateScoreUI() {
            document.getElementById('score').textContent = `คะแนน: ${score} | เวลา: ${Math.ceil(remainingTime)}`;
        }

        function handleMouseCollision() {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(foods);

            if (intersects.length > 0) {
                const intersectedFood = intersects[0].object;
                
                score += intersectedFood.userData.points;
                updateScoreUI();
                
                // ค้นหาและลบอาหารออกจากอาร์เรย์และฉาก
                const index = foods.indexOf(intersectedFood);
                if (index > -1) {
                    foods.splice(index, 1);
                }
                scene.remove(intersectedFood);
            }
        }
        
        function handleVRCollisions() {
            const sabers = [saber1, saber2];
            sabers.forEach(saber => {
                if (!saber.parent.visible) return;

                const saberPosition = new THREE.Vector3();
                saber.getWorldPosition(saberPosition);

                for (let i = foods.length - 1; i >= 0; i--) {
                    const food = foods[i];
                    const distance = saberPosition.distanceTo(food.position);
                    if (distance < 0.2) { 
                        score += food.userData.points;
                        updateScoreUI();
                        scene.remove(food);
                        foods.splice(i, 1);
                    }
                }
            });
        }

        // --- Game Loop ---
        function animate() {
            renderer.setAnimationLoop(render);
        }
        
        let lastTime = 0;
        function render(time) {
            if (lastTime > 0) {
                const deltaTime = (time - lastTime) / 1000;
                if (isPlaying && remainingTime > 0) {
                    const prevRemainingTime = remainingTime;
                    remainingTime = Math.max(0, remainingTime - deltaTime);
                    if (Math.ceil(prevRemainingTime) !== Math.ceil(remainingTime)) {
                         updateScoreUI();
                    }
                }
            }
            lastTime = time;

            if (isPlaying) {
                foods.forEach((food, index) => {
                    food.position.z += 0.05;
                    if (food.position.z > camera.position.z) { // ลบอาหารเมื่อลอยผ่านกล้องไปแล้ว
                        scene.remove(food);
                        foods.splice(index, 1);
                    }
                });

                // ตรวจสอบโหมดการเล่น
                if (renderer.xr.isPresenting) {
                    handleVRCollisions();
                } 
                // การชนของเมาส์จะถูกจัดการใน onMouseDown()
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

