<!DOCTYPE html>
<html lang="th">
<head>
    <title>นักรบโภชนาการ VR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif; /* ใช้ฟอนต์ที่อ่านง่าย */
            background-color: #111;
            color: #fff;
            overflow: hidden; /* ป้องกันการเลื่อนหน้าจอ */
        }
        canvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
            pointer-events: none; /* ทำให้ UI ไม่บังการคลิกใน VR */
        }
        .score {
            font-size: 5vw; /* ขนาดตัวอักษรปรับตามความกว้างจอ */
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        }
        .message {
            font-size: 3vw;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 15px;
        }
        /* ซ่อนปุ่ม VR เริ่มต้นของ three.js เพื่อใช้ปุ่มของเราเอง */
        #VRButton {
            position: absolute !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 100;
        }
    </style>
    <!-- โหลด Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ส่วนแสดงผล UI เช่น คะแนน และข้อความ -->
    <div id="ui">
        <div id="score" class="score">คะแนน: 0</div>
        <div id="message" class="message">กดปุ่ม Trigger บนคอนโทรลเลอร์เพื่อเริ่มเกม!</div>
    </div>

    <!-- REMOVED: Old script tags are no longer needed -->

    <script type="module">
        // FIXED: Switched to ES6 modules for reliable script loading.
        // This prevents race conditions by ensuring libraries are loaded before they are used.
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/webxr/VRButton.js';

        // --- การตั้งค่าพื้นฐาน (Setup) ---
        let camera, scene, renderer;
        let controller1, controller2;
        let saber1, saber2;

        // --- ตัวแปรสำหรับเกม (Game Variables) ---
        const foods = []; // อาร์เรย์สำหรับเก็บอาหารทั้งหมดที่ลอยอยู่
        let score = 0;
        let isPlaying = false;
        let spawnInterval;

        // Start the application directly. Module scripts are deferred by default.
        init();
        animate();
        
        function init() {
            // 1. Scene (ฉาก): เหมือนเวทีละครสำหรับวัตถุ 3D
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x201547); // สีท้องฟ้ายามค่ำคืน

            // 2. Camera (กล้อง): มุมมองของผู้เล่น
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0); // ตั้งตำแหน่งกล้องให้สูงระดับสายตา

            // 3. Renderer (ตัววาดภาพ): ทำหน้าที่วาดภาพจาก Scene และ Camera ลงบนจอ
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; // เปิดใช้งาน WebXR!
            document.body.appendChild(renderer.domElement);

            // 4. VR Button (ปุ่มเข้า VR)
            document.body.appendChild(VRButton.createButton(renderer));

            // 5. Lights (แสง): ถ้าไม่มีแสง เราจะมองไม่เห็นอะไรเลย
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // แสงทั่วไปนวลๆ
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8); // แสงจากดวงอาทิตย์
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            // 6. Floor (พื้น)
            const floorGeometry = new THREE.PlaneGeometry(10, 10, 10, 10);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, wireframe: true });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2; // หมุนให้ราบไปกับพื้น
            scene.add(floor);

            // --- ตั้งค่าคอนโทรลเลอร์ VR (VR Controllers) ---
            // คอนโทรลเลอร์ข้างซ้าย
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('selectstart', startGame); // เมื่อกดปุ่ม Trigger
            scene.add(controller1);

            // คอนโทรลเลอร์ข้างขวา
            controller2 = renderer.xr.getController(1);
            controller2.addEventListener('selectstart', startGame);
            scene.add(controller2);

            // สร้างดาบ (Sabers) สำหรับคอนโทรลเลอร์
            const saberGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8, 32);
            
            // ดาบเล่มที่ 1 (สีฟ้า)
            const saberMaterial1 = new THREE.MeshStandardMaterial({ color: 0x22aaff, emissive: 0x22aaff, emissiveIntensity: 1 });
            saber1 = new THREE.Mesh(saberGeometry, saberMaterial1);
            saber1.rotation.x = -Math.PI / 2;
            controller1.add(saber1);

            // ดาบเล่มที่ 2 (สีแดง)
            const saberMaterial2 = new THREE.MeshStandardMaterial({ color: 0xff2255, emissive: 0xff2255, emissiveIntensity: 1 });
            saber2 = new THREE.Mesh(saberGeometry, saberMaterial2);
            saber2.rotation.x = -Math.PI / 2;
            controller2.add(saber2);

            // จัดการขนาดหน้าจอเมื่อมีการเปลี่ยนแปลง
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- กลไกของเกม (Game Mechanics) ---
        function startGame() {
            if (isPlaying) return; // ถ้าเกมเล่นอยู่แล้ว ไม่ต้องเริ่มใหม่
            
            isPlaying = true;
            score = 0;
            updateScore(0);
            document.getElementById('message').style.display = 'none';

            // เริ่มปล่อยอาหารออกมาทุกๆ 1 วินาที
            spawnInterval = setInterval(spawnFood, 1000);
        }

        function spawnFood() {
            const isGoodFood = Math.random() > 0.3; // 70% เป็นอาหารดี, 30% เป็นอาหารไม่ดี
            let food;

            if (isGoodFood) {
                // อาหารดี: ทรงกลม (ผลไม้)
                const geometry = new THREE.SphereGeometry(0.15, 16, 16);
                const colors = [0x00ff00, 0xffff00, 0xffa500]; // เขียว, เหลือง, ส้ม
                const color = colors[Math.floor(Math.random() * colors.length)];
                const material = new THREE.MeshStandardMaterial({ color: color });
                food = new THREE.Mesh(geometry, material);
                food.userData = { type: 'good', points: 10 };
            } else {
                // อาหารไม่ดี: ทรงกล่อง (ขนม)
                const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const material = new THREE.MeshStandardMaterial({ color: 0x8B4513 }); // สีน้ำตาล
                food = new THREE.Mesh(geometry, material);
                food.userData = { type: 'bad', points: -5 };
            }

            // สุ่มตำแหน่งเริ่มต้นของอาหาร
            food.position.x = (Math.random() - 0.5) * 4; // สุ่มซ้ายขวา
            food.position.y = 1 + Math.random() * 1; // สุ่มความสูง
            food.position.z = -10; // เริ่มจากไกลๆ

            scene.add(food);
            foods.push(food);
        }
        
        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = `คะแนน: ${score}`;
        }

        function handleCollisions() {
            const sabers = [saber1, saber2];
            
            sabers.forEach(saber => {
                // ถ้าดาบไม่แสดงอยู่ ก็ไม่ต้องเช็ค
                if (!saber.parent.visible) return;

                const saberPosition = new THREE.Vector3();
                saber.getWorldPosition(saberPosition); // ตำแหน่งของดาบในโลก 3D

                // วนลูปเช็คอาหารแต่ละชิ้น
                for (let i = foods.length - 1; i >= 0; i--) {
                    const food = foods[i];
                    const distance = saberPosition.distanceTo(food.position);

                    // เช็คว่าดาบชนอาหารหรือไม่ (ระยะห่างน้อยกว่า 0.2)
                    if (distance < 0.2) { 
                        updateScore(food.userData.points);
                        
                        // ลบอาหารออกจากฉากและอาร์เรย์
                        scene.remove(food);
                        foods.splice(i, 1);
                    }
                }
            });
        }


        // --- Game Loop (วงจรหลักของเกม) ---
        function animate() {
            renderer.setAnimationLoop(render);
        }
        
        function render() {
            if (isPlaying) {
                // ทำให้วัตถุเคลื่อนที่
                foods.forEach((food, index) => {
                    food.position.z += 0.05; // เคลื่อนที่เข้ามาหาผู้เล่น

                    // ถ้าอาหารลอยผ่านไปแล้ว ให้ลบออก
                    if (food.position.z > 1) {
                        scene.remove(food);
                        foods.splice(index, 1);
                    }
                });
                
                // ตรวจสอบการชนกัน
                handleCollisions();
            }

            // วาดภาพลงบนจอ
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

